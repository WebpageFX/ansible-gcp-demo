- name: Install Jenkins
  hosts: web
  connection: ssh
  become: True
  vars:
    infrastructure_state: present
    jenkins_admin_username: admin
    jenkins_admin_password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              38613035316634313230353066643866306434646635666537336262353363393330346561643666
              3237326163343166383338353637363339643731613835330a363166643836363164353566363934
              62376539633133303333346231396663306161316261663335633333656536396436316137376132
              3235323137363538340a333633353530653264366230313534366638303962646132363835636634
              65313039333836633331653136626263316236353133393939343033313932353631
    ansible_user: ansible
    # https://github.com/jenkinsci/jenkins/blob/6ca9b5ee5f601f72fcd094f8d159272c6b504b2f/core/src/main/resources/jenkins/install/platform-plugins.json
    jenkins_plugins:
      - ansible
      - ansicolor
      - ant
      - antisamy-markup-formatter
      - build-timeout
      - cloudbees-folder
      - credentials-binding
      - email-ext
      - git
      - github-branch-source
      - gradle
      - ldap
      - mailer
      - matrix-auth
      - pam-auth
      - pipeline-github-lib
      - pipeline-stage-view
      - ssh-slaves
      - timestamper
      - workflow-aggregator
      - ws-cleanup
  roles:
    - geerlingguy.java
    - geerlingguy.jenkins
  pre_tasks:
    - name: Update apt
      apt:
        update_cache: yes
        cache_valid_time: 3600
      become: true

    - name: Ensure that pip is installed
      become: true
      package:
        name: pip
        state: present

    - name: Install ansible
      pip:
        name: ansible
        state: present

    - name: Stop jenkins
      service:
        name: jenkins
        state: stopped
      become: true
      when: infrastructure_state == 'absent'

    - name: Uninstall jenkins
      apt:
        name: jenkins
        state: absent
      become: true
      when: infrastructure_state == 'absent'

  tasks:
    - name: Debug jenkins_admin_password
      debug:
        var: jenkins_admin_password
      tags: debug
    - name: Ping
      ping:
      register: ping_result
    - name: Print ping result
      debug:
        var: ping_result
