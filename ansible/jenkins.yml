- name: Install Jenkins
  hosts: web
  connection: ssh
  become: True
  vars:
    infrastructure_state: present
    jenkins_admin_username: admin
    jenkins_admin_password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              32366464633537306638653262336231356531636531336361643031323264306630653932646234
              3038383262306465653364373061636239303032306165370a396165323736613163343330666237
              63616635376236663964363663376663326333646232613032653463333539643830363831393238
              6139336236353734660a326665666265623161616333353365393137633262373831313235636136
              35306266633030336532343764616261363039353936363030656261633064363637363639653431
              3739363131616436653230623163383966336331666262643262
    ansible_user: ansible
    # https://github.com/jenkinsci/jenkins/blob/6ca9b5ee5f601f72fcd094f8d159272c6b504b2f/core/src/main/resources/jenkins/install/platform-plugins.json
    jenkins_plugins:
      - ansible
      - ansicolor
      - ant
      - antisamy-markup-formatter
      - build-timeout
      - cloudbees-folder
      - credentials-binding
      - email-ext
      - git
      - github-branch-source
      - gradle
      - ldap
      - mailer
      - matrix-auth
      - pam-auth
      - pipeline-github-lib
      - pipeline-stage-view
      - ssh-slaves
      - timestamper
      - workflow-aggregator
      - ws-cleanup
  roles:
    - geerlingguy.java
    - geerlingguy.jenkins
  pre_tasks:
    - name: Update apt
      apt:
        update_cache: yes
        cache_valid_time: 3600
      become: true

    - name: Ensure that pip is installed
      become: true
      package:
        name: pip
        state: present

    - name: Install ansible
      pip:
        name: ansible
        state: present

    - name: Stop jenkins
      service:
        name: jenkins
        state: stopped
      become: true
      when: infrastructure_state == 'absent'

    - name: Uninstall jenkins
      apt:
        name: jenkins
        state: absent
      become: true
      when: infrastructure_state == 'absent'

  tasks:
    - name: Debug jenkins_admin_password
      debug:
        var: jenkins_admin_password
      tags: debug
    - name: Ping
      ping:
      register: ping_result
    - name: Print ping result
      debug:
        var: ping_result
